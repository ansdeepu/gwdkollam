
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for roles and authentication status
    function isSignedIn() {
      return request.auth != null;
    }

    function isApproved() {
      // isApproved is a field in the user's document in the /users collection.
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isApproved == true;
    }

    function isRole(role) {
      return isApproved() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }

    function isEditor() {
      return isRole('editor');
    }

    function isSupervisor() {
      return isRole('supervisor');
    }
    
    function isViewer() {
      return isRole('viewer');
    }
    
    // Editors and Viewers can read entire collections.
    function canReadCollection() {
      return isEditor() || isViewer();
    }
    
    function canWriteCollection() {
      return isEditor();
    }

    // === User Profiles ===
    // Editors/Viewers can see all profiles.
    // An authenticated user can read their own profile.
    match /users/{userId} {
      allow read: if canReadCollection() || request.auth.uid == userId;
      allow write: if isEditor();
    }

    // === Main File Entries (Deposit Works) ===
    // list: Allows collection-wide queries. This is safe for supervisors because the application
    // code *always* includes a "where('assignedSupervisorUids', 'array-contains', request.auth.uid)" clause in their queries.
    // get: Allows reading a single document if the supervisor is assigned.
    // write: Only Editors can write directly to file entries.
    match /fileEntries/{docId} {
      allow list: if canReadCollection() || isSupervisor();
      allow get: if canReadCollection() || (isSupervisor() && resource.data.assignedSupervisorUids.hasAny([request.auth.uid]));
      allow create, update, delete: if canWriteCollection();
    }

    // === ARS Entries ===
    // list: Allows collection-wide queries for supervisors, secured by app-level queries.
    // get: Allows reading a single document if the supervisor is assigned.
    // write: Only Editors can write directly.
    match /arsEntries/{docId} {
      allow list: if canReadCollection() || isSupervisor();
      allow get: if canReadCollection() || (isSupervisor() && resource.data.supervisorUid == request.auth.uid);
      allow create, update, delete: if canWriteCollection();
    }
    
    // === Pending Updates from Supervisors ===
    // Create: Supervisors can create new pending updates for review.
    // Read, Update, Delete: Only Editors can manage (read, approve, reject, delete) pending updates.
    match /pendingUpdates/{docId} {
      allow create: if isSupervisor();
      allow read, update, delete: if isEditor();
    }

    // === Staff Members (Establishment) ===
    // Read: Any approved user can read the staff list.
    // Write: Only Editors can manage staff members.
    match /staffMembers/{docId} {
      allow read: if isApproved();
      allow write: if isEditor();
    }
    
    // === Agency Registrations ===
    // Read: Any approved user can read agency data.
    // Write: Only Editors can manage agency data.
    match /agencyApplications/{docId} {
        allow read: if isApproved();
        allow write: if isEditor();
    }
    
    // === GWD Rates ===
    // Read: Any approved user can read the rates.
    // Write: Only Editors can manage rates.
    match /gwdRates/{docId} {
        allow read: if isApproved();
        allow write: if isEditor();
    }
  }
}
