
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for roles and authentication status
    function isSignedIn() {
      return request.auth != null;
    }

    function isApproved() {
      // isApproved is a field in the user's document in the /users collection.
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isApproved == true;
    }

    function isRole(role) {
      return isApproved() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }

    function isEditor() {
      return isRole('editor');
    }

    function isSupervisor() {
      return isRole('supervisor');
    }
    
    function isViewer() {
      return isRole('viewer');
    }
    
    function canReadCollection() {
      return isEditor() || isViewer();
    }
    
    function canWriteCollection() {
      return isEditor();
    }

    // === User Profiles ===
    // Editors/Viewers can see all profiles.
    // An authenticated user can read their own profile.
    match /users/{userId} {
      allow read: if canReadCollection() || request.auth.uid == userId;
      allow write: if isEditor();
    }

    // === Main File Entries (Deposit Works) ===
    match /fileEntries/{docId} {
      // Read access: Editors/Viewers can get any document. Supervisors can only get documents they are assigned to.
      allow get: if canReadCollection() || (isSupervisor() && resource.data.assignedSupervisorUids.hasAny([request.auth.uid]));
      
      // List access: This remains permissive for supervisors as client-side queries handle filtering.
      allow list: if canReadCollection() || isSupervisor();
      
      // Write access: Only editors can create or delete file entries directly.
      // Updates must go through the pendingUpdates collection for both supervisors and editors to ensure a consistent workflow.
      allow create, delete: if canWriteCollection();
      allow update: if false; // All updates must go through the pending updates workflow.
    }

    // === ARS Entries ===
    match /arsEntries/{docId} {
      allow get: if canReadCollection() || (isSupervisor() && resource.data.supervisorUid == request.auth.uid);
      allow list: if canReadCollection() || isSupervisor();
      allow create, update, delete: if canWriteCollection();
    }
    
    // === Pending Updates from Supervisors ===
    match /pendingUpdates/{docId} {
      // Supervisors and Editors can create updates. Supervisors can also read and delete updates they have submitted.
      allow create: if isSupervisor() || isEditor();
      allow read, delete: if (isSupervisor() && request.auth.uid == resource.data.submittedByUid) || isEditor();
      
      // Only editors can approve/reject by updating the status or the main document.
      allow update: if isEditor();
    }

    // === Staff Members (Establishment) ===
    match /staffMembers/{docId} {
      allow read: if isApproved();
      allow write: if isEditor();
    }
    
    // === Agency Registrations ===
    match /agencyApplications/{docId} {
      allow read: if isApproved();
      allow write: if isEditor();
    }
    
    // === GWD Rates ===
    match /gwdRates/{docId} {
      allow read: if isApproved();
      allow write: if isEditor();
    }
    
    // === eTenders ===
    match /eTenders/{docId} {
      allow read: if isApproved();
      allow write: if isEditor();
    }
    
    // === Bidders ===
    match /bidders/{docId} {
      allow read: if isApproved();
      allow write: if isEditor();
    }

    // === App Settings (Dropdowns, etc.) ===
    match /officeAddresses/{docId} {
      allow read: if isApproved();
      allow write: if isEditor();
    }
    
    match /localSelfGovernments/{docId} {
      allow read: if isApproved();
      allow write: if isEditor();
    }

    match /constituencies/{docId} {
      allow read: if isApproved();
      allow write: if isEditor();
    }
    
    match /rateDescriptions/{docId} {
      allow read: if isApproved();
      allow write: if isEditor();
    }
  }
}
