rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isEditor() {
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'editor';
    }

    function isViewer() {
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'viewer';
    }

    function isSupervisor() {
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'supervisor';
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Users Collection: Users can manage their own profile. Editors can manage all.
    match /users/{userId} {
      allow read: if isEditor() || isViewer() || isOwner(userId);
      allow write: if isEditor() || isOwner(userId);
    }
    
    // Staff Members, GWD Rates, Office Addresses, LSG Maps: Read-only for most, write for editors.
    match /staffMembers/{docId} {
      allow read: if isAuthenticated();
      allow write: if isEditor();
    }
    match /gwdRates/{docId} {
      allow read: if isAuthenticated();
      allow write: if isEditor();
    }
    match /officeAddresses/{docId} {
      allow read: if isAuthenticated();
      allow write: if isEditor();
    }
    match /localSelfGovernments/{docId} {
      allow read: if isAuthenticated();
      allow write: if isEditor();
    }

    // Main Data Collections: Deposit Works, Private Works, ARS, Agency Registrations, eTenders
    match /fileEntries/{docId} {
      allow read: if isEditor() || isViewer() || (isSupervisor() && request.auth.uid in resource.data.assignedSupervisorUids);
      allow write: if isEditor(); // Supervisors write to pendingUpdates, not directly.
    }
    match /arsEntries/{docId} {
      allow read: if isEditor() || isViewer() || (isSupervisor() && request.auth.uid == resource.data.supervisorUid);
      allow write: if isEditor();
    }
    match /agencyApplications/{docId} {
      allow read: if isAuthenticated();
      allow write: if isEditor();
    }
    match /eTenders/{docId} {
      allow read: if isEditor() || isViewer();
      allow write: if isEditor();
    }

    // Pending Updates: Supervisors can create them, Editors can read/update/delete.
    match /pendingUpdates/{updateId} {
      allow read: if isEditor();
      allow create: if isSupervisor();
      allow update, delete: if isEditor();
    }
  }
}
