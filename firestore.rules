
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isEditor() {
      return isAuthenticated() && getUserRole() == 'editor';
    }

    function isSupervisor() {
      return isAuthenticated() && getUserRole() == 'supervisor';
    }

    function isViewer() {
      return isAuthenticated() && getUserRole() == 'viewer';
    }

    // Users Collection Rules
    match /users/{userId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated() && (request.auth.uid == userId || isEditor() || isViewer());
      allow create: if isEditor();
      allow update: if (isEditor() || request.auth.uid == userId);
      allow delete: if isEditor() && request.auth.uid != userId; // Prevent self-delete
    }

    // Generic Rules for most data collections
    function canReadCollection() {
      return isEditor() || isViewer();
    }
    
    function canWriteCollection() {
      return isEditor();
    }
    
    // --- Data Collections ---

    // fileEntries requires special read logic for supervisors
    match /fileEntries/{docId} {
      allow get, list: if canReadCollection() || (isSupervisor() && resource.data.assignedSupervisorUids.hasAny([request.auth.uid]));
      allow create, update, delete: if canWriteCollection();
    }

    // arsEntries requires special read logic for supervisors
    match /arsEntries/{docId} {
        allow get, list: if canReadCollection() || (isSupervisor() && resource.data.supervisorUid == request.auth.uid);
        allow create, update, delete: if canWriteCollection();
    }
    
    // agencyApplications, gwdRates, and staffMembers are read-only for supervisors
    match /agencyApplications/{docId} {
        allow read: if canReadCollection() || isSupervisor();
        allow write: if canWriteCollection();
    }

    match /gwdRates/{docId} {
        allow read: if canReadCollection() || isSupervisor();
        allow write: if canWriteCollection();
    }
    
    match /staffMembers/{docId} {
        allow read: if canReadCollection() || isSupervisor();
        allow write: if canWriteCollection();
    }

    // pendingUpdates are only accessible by editors
    match /pendingUpdates/{docId} {
        allow read, write: if isEditor();
    }
  }
}
